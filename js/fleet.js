const operator_vals = { "vehicleList": { "type": "FeatureCollection", "features": [{ "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.40200216303793, 35.47187041552116] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.4969688104323, 35.56922990861866] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.6896556776309, 35.79931214370945] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.3267537985272, 35.643800093825206] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.4930225717258, 35.513167672563405] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.428037851125, 35.51968751895966] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.31325006360512, 35.624737011880526] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.44571605930258, 35.65499691275003] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.33494426024598, 35.618151711701834] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.59331826260404, 35.833659879566156] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.4941170845898, 35.35904134971723] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.4284673435738, 35.66752426869719] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.4460801301541, 35.530419947317476] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.64446497906204, 35.75115074483594] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.65549859600011, 35.67589229913746] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.53887330606435, 35.49943441798222] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.3140419041443, 35.61696121385045] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.74401816698787, 35.65793993844647] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.53165080247692, 35.78059716585538] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.77146702844007, 35.67105362864534] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.6547537502569, 35.57306214696648] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.40414198272904, 35.445657714822] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.45744758887008, 35.66587236759621] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.6039492898523, 35.80480365084892] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.42906729180896, 35.54832874073508] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.51010477538597, 35.36631787988027] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.47330719147834, 35.643531197672196] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.61751843074046, 35.5876135823629] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.3980550563923, 35.588371154835315] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.64158549740856, 35.808816288373706] } }] }, "warehouseList": { "type": "FeatureCollection", "features": [{ "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.6225070716386, 35.460790211549025] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.37095637256152, 35.56598749160571] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.7197984978907, 35.75188987701941] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.7508358997065, 35.70244339578337] } }, { "type": "Feature", "properties": {}, "geometry": { "type": "Point", "coordinates": [139.519500440903, 35.60583317567554] } }] }, "deliveries": { "139.6225070716386_35.460790211549025": { "id": "139.6225070716386_35.460790211549025", "name": "倉庫1", "coordinates": [139.6225070716386, 35.460790211549025], "from": { "139.4941170845898_35.35904134971723": { "id": "139.4941170845898_35.35904134971723", "coordinates": [139.4941170845898, 35.35904134971723], "name": "車両1", "address": "〒245-0064 神奈川県横浜市戸塚区影取町10番地6" }, "139.53887330606435_35.49943441798222": { "id": "139.53887330606435_35.49943441798222", "coordinates": [139.53887330606435, 35.49943441798222], "name": "車両2", "address": "〒241-0001 神奈川県横浜市旭区上白根町744番地42" }, "139.51010477538597_35.36631787988027": { "id": "139.51010477538597_35.36631787988027", "coordinates": [139.51010477538597, 35.36631787988027], "name": "車両3", "address": "日本神奈川県横浜市戸塚区小雀町2506" } }, "address": "〒220-0011 神奈川県横浜市西区高島2丁目2番1号" }, "139.37095637256152_35.56598749160571": { "id": "139.37095637256152_35.56598749160571", "name": "倉庫2", "coordinates": [139.37095637256152, 35.56598749160571], "from": { "139.40200216303793_35.47187041552116": { "id": "139.40200216303793_35.47187041552116", "coordinates": [139.40200216303793, 35.47187041552116], "name": "車両4", "address": "〒243-0431 神奈川県海老名市上今泉4丁目21番7ー6号" }, "139.3267537985272_35.643800093825206": { "id": "139.3267537985272_35.643800093825206", "coordinates": [139.3267537985272, 35.643800093825206], "name": "車両5", "address": "〒193-0934 東京都八王子市小比企町1316番地3" }, "139.428037851125_35.51968751895966": { "id": "139.428037851125_35.51968751895966", "coordinates": [139.428037851125, 35.51968751895966], "name": "車両6", "address": "〒252-0311 神奈川県相模原市南区東林間2丁目17番12号" }, "139.31325006360512_35.624737011880526": { "id": "139.31325006360512_35.624737011880526", "coordinates": [139.31325006360512, 35.624737011880526], "name": "車両7", "address": "〒193-0935 東京都八王子市大船町378番地10" }, "139.33494426024598_35.618151711701834": { "id": "139.33494426024598_35.618151711701834", "coordinates": [139.33494426024598, 35.618151711701834], "name": "車両8", "address": "〒192-0915 東京都八王子市宇津貫町1468番地1" }, "139.4460801301541_35.530419947317476": { "id": "139.4460801301541_35.530419947317476", "coordinates": [139.4460801301541, 35.530419947317476], "name": "車両9", "address": "〒252-0318 神奈川県相模原市南区上鶴間本町6丁目7番3号" }, "139.3140419041443_35.61696121385045": { "id": "139.3140419041443_35.61696121385045", "coordinates": [139.3140419041443, 35.61696121385045], "name": "車両10", "address": "〒193-0935 東京都八王子市大船町866番地" }, "139.40414198272904_35.445657714822": { "id": "139.40414198272904_35.445657714822", "coordinates": [139.40414198272904, 35.445657714822], "name": "車両11", "address": "〒243-0413 神奈川県海老名市国分寺台1丁目5番16ー1号" }, "139.42906729180896_35.54832874073508": { "id": "139.42906729180896_35.54832874073508", "coordinates": [139.42906729180896, 35.54832874073508], "name": "車両12", "address": "〒252-0301 神奈川県相模原市南区鵜野森1丁目28番17号" }, "139.3980550563923_35.588371154835315": { "id": "139.3980550563923_35.588371154835315", "coordinates": [139.3980550563923, 35.588371154835315], "name": "車両13", "address": "〒194-0204 東京都町田市小山田桜台2丁目9番10号" } }, "address": "〒252-0237 神奈川県相模原市中央区千代田2丁目1番8号" }, "139.7197984978907_35.75188987701941": { "id": "139.7197984978907_35.75188987701941", "name": "倉庫3", "coordinates": [139.7197984978907, 35.75188987701941], "from": { "139.6896556776309_35.79931214370945": { "id": "139.6896556776309_35.79931214370945", "coordinates": [139.6896556776309, 35.79931214370945] }, "139.59331826260404_35.833659879566156": { "id": "139.59331826260404_35.833659879566156", "coordinates": [139.59331826260404, 35.833659879566156] }, "139.64446497906204_35.75115074483594": { "id": "139.64446497906204_35.75115074483594", "coordinates": [139.64446497906204, 35.75115074483594] }, "139.53165080247692_35.78059716585538": { "id": "139.53165080247692_35.78059716585538", "coordinates": [139.53165080247692, 35.78059716585538] }, "139.6039492898523_35.80480365084892": { "id": "139.6039492898523_35.80480365084892", "coordinates": [139.6039492898523, 35.80480365084892] }, "139.64158549740856_35.808816288373706": { "id": "139.64158549740856_35.808816288373706", "coordinates": [139.64158549740856, 35.808816288373706] } }, "address": "〒173-0004 東京都板橋区板橋4丁目49番28号" }, "139.7508358997065_35.70244339578337": { "id": "139.7508358997065_35.70244339578337", "name": "倉庫4", "coordinates": [139.7508358997065, 35.70244339578337], "from": { "139.65549859600011_35.67589229913746": { "id": "139.65549859600011_35.67589229913746", "coordinates": [139.65549859600011, 35.67589229913746] }, "139.74401816698787_35.65793993844647": { "id": "139.74401816698787_35.65793993844647", "coordinates": [139.74401816698787, 35.65793993844647] }, "139.77146702844007_35.67105362864534": { "id": "139.77146702844007_35.67105362864534", "coordinates": [139.77146702844007, 35.67105362864534] } }, "address": "〒101-0061 東京都千代田区神田三崎町3丁目9番5号" }, "139.519500440903_35.60583317567554": { "id": "139.519500440903_35.60583317567554", "name": "倉庫5", "coordinates": [139.519500440903, 35.60583317567554], "from": { "139.4969688104323_35.56922990861866": { "id": "139.4969688104323_35.56922990861866", "coordinates": [139.4969688104323, 35.56922990861866] }, "139.4930225717258_35.513167672563405": { "id": "139.4930225717258_35.513167672563405", "coordinates": [139.4930225717258, 35.513167672563405] }, "139.44571605930258_35.65499691275003": { "id": "139.44571605930258_35.65499691275003", "coordinates": [139.44571605930258, 35.65499691275003] }, "139.4284673435738_35.66752426869719": { "id": "139.4284673435738_35.66752426869719", "coordinates": [139.4284673435738, 35.66752426869719] }, "139.6547537502569_35.57306214696648": { "id": "139.6547537502569_35.57306214696648", "coordinates": [139.6547537502569, 35.57306214696648] }, "139.45744758887008_35.66587236759621": { "id": "139.45744758887008_35.66587236759621", "coordinates": [139.45744758887008, 35.66587236759621] }, "139.47330719147834_35.643531197672196": { "id": "139.47330719147834_35.643531197672196", "coordinates": [139.47330719147834, 35.643531197672196] }, "139.61751843074046_35.5876135823629": { "id": "139.61751843074046_35.5876135823629", "coordinates": [139.61751843074046, 35.5876135823629] } }, "address": "〒215-0011 神奈川県川崎市麻生区百合丘1丁目8番地51" } } }
let map

const loadMap = () => {
    const parent = document.getElementById('list-parent')
    parent.innerHTML = '<div id="list" class="list"></div>'
    map = new mapboxgl.Map({
        container: 'map',
        //style: 'mapbox://styles/mapbox/light-v10',
        style: 'mapbox://styles/kenji-shima/clpjgdyhr000w01pxg9064ewm',
        center: [lng, lat],
        zoom: 14,
        scrollZoom: true,
    })

    map.on('style.load', () => {
        dispLoading('ロード中')
        map.setConfigProperty('basemap', 'lightPreset', 'day')
        map.setConfigProperty('basemap', 'showPlaceLabels', false)
        map.setConfigProperty('basemap', 'showRoadLabels', false)
        map.setConfigProperty('basemap', 'showPointOfInterestLabels', false)
        map.setConfigProperty('basemap', 'showTransitLabels', false)

        new LegacyLayers({ map })
        //new MapPolygonDrawer({ map })

        japanifyMap(map)
        addThreeboxLayer(map)
        loadModel(TRUCK, 2)
        createDeliveries()
        setTimeout(test,15000)

    })
}
function test() {
    const operator_vals = {
        "vehicleList": vehicleList,
        "warehouseList": warehouseList,
        "deliveries": deliveries
    }
    console.log("test",operator_vals)
    const url = makeTextFile(Flatted.stringify(operator_vals))
    const a = document.getElementById('list').appendChild(document.createElement('a'))
    a.href = url
    a.innerHTML = 'test'
}

window.loadMap = loadMap

loadMap()

const TRUCK = 'truck.glb'

const area = {
    type: 'geojson',
    data: {
        type: "FeatureCollection",
        features: [
            {
                type: "Feature",
                geometry: {
                    type: "Polygon",
                    coordinates: [[[139.61363052869984, 35.85311880463962], [139.3829896591812, 35.772795205530514], [139.27974964692805, 35.59671579651905], [139.34353685099427, 35.32300627956721], [139.4971021709619, 35.336212517496065], [139.63413411642927, 35.413971557102684], [139.65545835805915, 35.441507094621585], [139.6243562155126, 35.46381014443722], [139.6737877036457, 35.49620007161715], [139.76289036024235, 35.65970193350965], [139.901601093877, 35.68761750804062], [139.61363052869984, 35.85311880463962]]]
                }
            }
        ]
    }
}

let vehicleList
let warehouseList
let deliveries = {}

const isDriver = () => {
    const segmentedValue = document.querySelector('input[name="segmented"]:checked').value;
    return segmentedValue == 'driver'
}

const setLists = () => {
    deliveries = {}
    if (!isDriver()) {
        vehicleList = createRandomPointsIn(area, 30)
        warehouseList = createRandomPointsIn(area, 5)
        //vehicleList = operator_vals.vehicleList
        //warehouseList = operator_vals.warehouseList
        //deliveries = operator_vals.deliveries
    } else {
        vehicleList = createRandomPointsIn(area, 2)
        warehouseList = createRandomPointsIn(area, 1)
    }
}

const vehiclePrefix = '車両'
const warehousePrefix = '倉庫'
async function createDeliveries() {
    setLists()
    const addressPromises = warehouseList.features.map(f =>
        getFirstAddress(f.geometry.coordinates)
    )

    const addresses = await Promise.all(addressPromises)

    let i = 0
    for (let f of warehouseList.features) {
        let c = f.geometry.coordinates
        deliveries[`${c[0]}_${c[1]}`] = {
            id: `${c[0]}_${c[1]}`,
            name: `${warehousePrefix}${i + 1}`,
            coordinates: c,
            from: {},
            address: addresses[i]
        }
        i++
    }

    for (let f of vehicleList.features) {
        let c = f.geometry.coordinates
        let p = turf.point(c)
        let distance = 999999
        let closest
        for (let f2 of warehouseList.features) {
            let c2 = f2.geometry.coordinates
            let p2 = turf.point(c2)
            let d = turf.distance(p, p2)
            if (d < distance) {
                distance = d
                closest = c2
            }
        }
        deliveries[`${closest[0]}_${closest[1]}`].from[`${c[0]}_${c[1]}`] = { id: `${c[0]}_${c[1]}`, coordinates: c }
    }
    

    let vehicleCount = 1
    for (let id in deliveries) {
        let w = deliveries[id]
        const addressPromises2 = Object.values(w.from).map(from =>
            getFirstAddress(from.coordinates)
        )
        const addresses2 = await Promise.all(addressPromises2)
        let i = 0
        for (let f in w.from) {
            let from = w.from[f]
            from.name = `${vehiclePrefix}${vehicleCount}`
            from.address = addresses2[i]
            i++
            vehicleCount++
        }
    }

    setDriverMode()
    await startAllVehicles()
    createList()
    fitAllRoutesToCamera()
    removeLoading()
}

function setDriverMode() {
    const names = ['相棒', '自分']
    if (isDriver()) {
        for (let id in deliveries) {
            let w = deliveries[id]
            let index = 0
            for (let f in w.from) {
                let from = w.from[f]
                from.name = names[index]
                index++
            }
        }
        document.getElementById('openModalBtn').style = 'visibility: visible;'
    } else {
        document.getElementById('openModalBtn').style = 'visibility: hidden;'
    }
}

function openChatModal() {
    document.getElementById('chatModal').style.display = 'block';
}
window.openChatModal = openChatModal

function closeChatModal() {
    document.getElementById('chatModal').style.display = 'none';
}
window.closeChatModal = closeChatModal


function createList() {
    const parent = document.getElementById('list')
    for (let id in deliveries) {
        let w = deliveries[id]
        const details = parent.appendChild(document.createElement('details'))
        details.id = id
        details.setAttribute('open', '')
        const summary = details.appendChild(document.createElement('summary'))
        summary.innerHTML = w.name
        summary.onclick = () => toggleWareHouse(id)

        const vehicleList = details.appendChild(document.createElement('div'))

        for (let f in w.from) {
            let from = w.from[f]
            const vehicle = vehicleList.appendChild(document.createElement('div'))
            const span = vehicle.appendChild(document.createElement('span'))
            span.className = 'flex-container'

            const circle = span.appendChild(document.createElement('div'))
            circle.className = 'circle'
            circle.style.backgroundColor = from.color

            const a = span.appendChild(document.createElement('a'))
            a.className = 'vehicle-link'
            a.onclick = () => singleVehicleOut(w.id, from.id)
            a.innerText = from.name

            const cargo = vehicle.appendChild(document.createElement('div'))
            cargo.innerHTML = `積載量: ${from.cargo}%`
            cargo.style = `color: ${getCargoColor(from.cargo)}`

            const eta = vehicle.appendChild(document.createElement('div'))
            eta.innerHTML = `ETA: ${from.eta}`

            const speed = vehicle.appendChild(document.createElement('div'))
            speed.innerHTML = `時速: ${from.speed} km`

        }

    }
}
const getCargoColor = (val) => {
    if (val >= 90) return 'red'
    else if (val >= 50) return 'orange'
    else return 'green'
}

let currentDetails = null;

const toggleWareHouse = (id) => {
    chaseRouteId = ''
    const details = document.getElementById(id)
    const isOpen = details.getAttribute('open') !== null
    if (isOpen) {
        const w = deliveries[id]
        for (let f in w.from) {
            const from = w.from[f]
            const route = `${from.coordinates[0]}_${from.coordinates[1]}_${w.coordinates[0]}_${w.coordinates[1]}`
            if (map.getLayer(route)) {
                map.removeLayer(route)
            }
            if (map.getSource(route)) {
                map.removeSource(route)
            }
            from.popup.remove()
        }
        w.marker.remove()
    } else {
        showEnrouteToWarehouse(id)
    }
}

const toggleDetails = (detailsId) => {
    removeAllRoutes(map)
    removeAllPopups()
    removeAllMarkers()
    var details = document.getElementById(detailsId)

    if (currentDetails && currentDetails !== details) {
        currentDetails.style.display = "none"
    }

    if (details.style.display === "none" || details.style.display === "") {
        details.style.display = "block"
        currentDetails = details
        showEnrouteToWarehouse(detailsId)
    } else {
        details.style.display = "none"
        currentDetails = null
    }

    chaseRouteId = ''

}

const showEnrouteToWarehouse = (id) => {
    const w = deliveries[id]
    w.marker.addTo(map)
    let linestrings = []
    for (let f in w.from) {
        let from = w.from[f]
        from.popup.addTo(map)
        setRoute(map, from.coordinates, w.coordinates, getRandomColor(), null)
    }
    fitAllRoutesToCamera(id)
}

const getAllRoutesTo = (wId) => {
    let linestrings = []
    const w = deliveries[wId]
    for (let f in w.from) {
        let from = w.from[f]
        const c = routes[`${from.coordinates[0]}_${from.coordinates[1]}_${w.coordinates[0]}_${w.coordinates[1]}`].route.coordinates
        const feature = {
            geometry: {
                type: "LineString",
                coordinates: c
            }
        }
        linestrings.push(feature)
    }
    return linestrings
}

const fitAllRoutesToCamera = (wId) => {
    let linestrings = []
    if (wId) {
        linestrings = getAllRoutesTo(wId)
    } else {
        for (let id in deliveries) {
            linestrings = linestrings.concat(getAllRoutesTo(id))
        }
    }
    if (linestrings.length == 0) {
        return
    }
    const featureCollection = turf.featureCollection(linestrings)
    const bbox = turf.bbox(featureCollection)
    map.fitBounds([
        [bbox[0], bbox[1]], // southwest coordinates of the bbox (minX, minY)
        [bbox[2], bbox[3]]  // northeast coordinates of the bbox (maxX, maxY)
    ], {
        padding: { top: 10, bottom: 25, left: 15, right: 5 }
    })
}

const singleVehicleOut = (parentid, id) => {
    chaseRouteId = ''
    const w = deliveries[parentid]
    let from = w.from[id]
    map.flyTo({
        center: from.currentPosition,
        zoom: 18,
        duration: 1000
    })
}
window.singleVehicleOut = singleVehicleOut

let runningVehiclesList = []

const showVehicleRoute = (parentid, id) => {
    const w = deliveries[parentid]
    let from = w.from[id]
    const routeId = `${from.coordinates[0]}_${from.coordinates[1]}_${w.coordinates[0]}_${w.coordinates[1]}`
    //chaseRouteId = routeId
    setRoute(map, from.coordinates, w.coordinates, getRandomColor(), null)
    map.flyTo({
        center: from.currentPosition,
        zoom: 18,
        duration: 1000
    })

}

const chaseVehicle = (parentid, id) => {
    const w = deliveries[parentid]
    const from = w.from[id]
    const routeId = `${from.coordinates[0]}_${from.coordinates[1]}_${w.coordinates[0]}_${w.coordinates[1]}`
    chaseRouteId = routeId
}
window.chaseVehicle = chaseVehicle

async function startAllVehicles() {
    let promises = []
    for (let id in deliveries) {
        const w = deliveries[id]
        const marker = createMarker(map, w.coordinates)
        w.marker = marker
        for (let f in w.from) {
            let from = w.from[f]
            const routeId = `${from.coordinates[0]}_${from.coordinates[1]}_${w.coordinates[0]}_${w.coordinates[1]}`
            from.color = getRandomColor()
            const routePromise = setRoute(map, from.coordinates, w.coordinates, from.color, from)
            promises.push(routePromise)

            const popup = new mapboxgl.Popup({ offset: 25, closeOnClick: false, closeButton: false })
                .setHTML(`<span>${from.name}</span><div><a class="chase-link" onclick="chaseVehicle('${id}', '${f}')">追跡</a></div>`)
                .setLngLat(from.coordinates)
                .addTo(map)
            from.popup = popup

            await routePromise

            const model = duplicateModel(TRUCK, from.coordinates)
            const speed = getRandomValueFromArray([30, 40, 50, 60])
            from.speed = speed
            traceRoute(map, routeId, from, speed, model, popup)
            runningVehiclesList.push(from.id)

            const cargo = getRandomValueFromArray([10, 20, 30, 40, 50, 60, 70, 80, 90, 100])
            from.cargo = cargo
        }
    }
    await Promise.all(promises)
}

function removeAllPopups() {
    for (let id in deliveries) {
        const w = deliveries[id]
        for (let f in w.from) {
            const from = w.from[f]
            from.popup.remove()
        }
    }
}

function removeAllMarkers() {
    for (let id in deliveries) {
        const w = deliveries[id]
        w.marker.remove()
    }
}

let chaseRouteId
const traceRoute = (map, id, from, speed, model, popup) => {

    // https://en.wikipedia.org/wiki/Transpeninsular_Line
    const transpeninsularLine = {
        type: "Feature",
        geometry: routes[id].route
    };

    // アニメーションの前に、線の長さを計算
    const pathDistance = turf.lineDistance(transpeninsularLine, 'kilometers');

    const duration = ((pathDistance / speed) * 60 * 60 * 1000);

    let startTime;

    var modelPreviousPosition = [lng, lat]

    const frame = (time) => {

        if (!startTime) startTime = time;
        const animationPhase = (time - startTime) / duration

        // animationPhase に基づいて、パスに沿った距離を計算
        const targetPosition = turf.along(transpeninsularLine, pathDistance * animationPhase).geometry.coordinates
        const bearing = 60 - animationPhase * 50.0

        from.currentPosition = targetPosition

        if (id === chaseRouteId) {
            const cameraPosition = computeCameraPosition(60, bearing, targetPosition, 30)
            const camera = map.getFreeCameraOptions()

            camera.position = mapboxgl.MercatorCoordinate.fromLngLat(cameraPosition, 30)
            camera.lookAtPoint(targetPosition)

            map.setFreeCameraOptions(camera)
            map.setZoom(18)
        }

        if (animationPhase > 1) {
            return
        }

        model.rotation.z = getBearing(modelPreviousPosition, targetPosition)
        model.setCoords(targetPosition)
        modelPreviousPosition = targetPosition

        popup.setLngLat(targetPosition)

        window.requestAnimationFrame(frame);
    };

    window.requestAnimationFrame(frame);

    const intervalid = setInterval(() => {
        startTime = undefined;
        window.requestAnimationFrame(frame);
    }, duration + 1500);

    const stopInterval = () => {
        clearInterval(intervalid);
    };

    setTimeout(stopInterval, duration);
}
