<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" rel="stylesheet" />
    <style>
        #map,
        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoia2Vuamktc2hpbWEiLCJhIjoiY2xhZ2NmZ3BiMGFqbzNubThpbWMxOXU3MCJ9.JlXUW8MwwX1LhhMnbWyUQw';

        const map = new mapboxgl.Map({
            container: 'map', // container ID
            style: 'mapbox://styles/mapbox/streets-v11', // style URL
            //center: [-73.94784073645798, 40.79784015133043], // starting position [lng, lat]
            center : [-122.411, 37.773],
            zoom: 11.462054837977956 // starting zoom
        });

        map.on('load', main)

        async function main() {
            //const res = await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/-73.99156486140473%2C40.7286773992962%3B-74.01075805485813%2C40.86499140725101?alternatives=true&geometries=geojson&language=en&overview=simplified&steps=true&access_token=${mapboxgl.accessToken}`)
            const res = await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/-122.411%2C37.773%3B-122.40061448679577%2C37.763252389415186%3B-122.43072747880516%2C37.76359647118012?alternatives=true&geometries=geojson&language=en&overview=simplified&steps=true&access_token=${mapboxgl.accessToken}`)
            const json = await res.json()
            const { routes } = json
            const geometries = routes.map(r => turf.feature(r.geometry))

            map.addSource('route', {
                'type': 'geojson',
                'data': turf.featureCollection(geometries)
            })

            map.addLayer({
                'id': 'route',
                'type': 'line',
                'source': 'route',
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round',
                },
                'paint': {
                    'line-color': '#888',
                    'line-width': 8,
                    'line-opacity': 0.50,
                }
            });

            const intersections = turf.lineIntersect(geometries[0], geometries[1])

            map.addSource('intersections', {
                'type': 'geojson',
                'data': intersections,
            })

            map.addLayer({
                'id': 'intersections',
                'type': 'circle',
                'source': 'intersections',
                'paint': {
                    'circle-color': '#4264fb',
                    'circle-radius': 8,
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#ffffff'
                }
            })

            const selected = longestDistanceBetweenPoints(intersections)

            map.addSource('selected-intersections', {
                'type': 'geojson',
                'data': selected,
            })

            map.addLayer({
                'id': 'selected-intersections',
                'type': 'circle',
                'source': 'selected-intersections',
                'paint': {
                    'circle-color': '#FF0000',
                    'circle-radius': 8,
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#ffffff'
                }
            })

            const slices = lineSlices(selected.features[0], selected.features[1], geometries)
            map.addSource('selected-slices', {
                'type': 'geojson',
                'data': slices,
            })

            map.addLayer({
                'id': 'selected-slices',
                'type': 'line',
                'source': 'selected-slices',
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round',
                },
                'paint': {
                    'line-color': '#FF0000',
                    'line-width': 8,
                    'line-opacity': 0.50,
                }
            })

            const mps = midpoints(slices)

            map.addSource('selected-midpoints', {
                'type': 'geojson',
                'data': mps,
            })

            map.addLayer({
                'id': 'selected-midpoints',
                'type': 'circle',
                'source': 'selected-midpoints',
                'paint': {
                    'circle-color': '#00FF00',
                    'circle-radius': 8,
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#ffffff'
                }
            })
        }

        // this function should be renamed something like
        // longestLengthBetweenPointsOnLine, and pass the route
        // geometry and use turf.length instead of turf.distance
        // as portions of the route can double back and make
        // turf.distance inaccurate.
        function longestDistanceBetweenPoints({ features }) {
            let longestDistance = 0
            let foundP1 = null
            let foundP2 = null

            for (let i = 1; i < features.length; i += 1) {
                const p1 = features[i - 1]
                const p2 = features[i]

                // use turf.length instead
                const dist = turf.distance(p1, p2)

                if (dist > longestDistance) {
                    foundP1 = p1
                    foundP2 = p2
                    longestDistance = dist
                }
            }

            return turf.featureCollection([foundP1, foundP2])
        }

        function lineSlices(p1, p2, geos) {
            const slices = []

            for (const geo of geos) {
                slices.push(turf.lineSlice(p1, p2, geo))
            }

            return turf.featureCollection(slices)
        }

        function midpoints({ features }) {
            const result = []

            for (const feature of features) {
                const length = turf.length(feature)
                const midpoint = turf.along(feature, length / 2)

                result.push(midpoint)
            }

            return turf.featureCollection(result)
        }
    </script>
</body>

</html>